USE [GD2C2016]
GO


-- DROP TABLAS 

IF OBJECT_ID('RANDOM.CANCELACION') IS NOT NULL
DROP TABLE RANDOM.CANCELACION
IF OBJECT_ID('RANDOM.TIPO_CANCELACION') IS NOT NULL
DROP TABLE RANDOM.TIPO_CANCELACION
IF OBJECT_ID('RANDOM.TURNO') IS NOT NULL
DROP TABLE RANDOM.TURNO
IF OBJECT_ID('RANDOM.RESULTADO_TURNO') IS NOT NULL
DROP TABLE RANDOM.RESULTADO_TURNO
IF OBJECT_ID('RANDOM.AGENDA_HORARIO_DISPONIBLE') IS NOT NULL
DROP TABLE RANDOM.AGENDA_HORARIO_DISPONIBLE
IF OBJECT_ID('RANDOM.DIA') IS NOT NULL
DROP TABLE RANDOM.DIA  
IF OBJECT_ID('RANDOM.BONO') IS NOT NULL
DROP TABLE RANDOM.BONO
IF OBJECT_ID('RANDOM.COMPRA_BONO') IS NOT NULL
DROP TABLE RANDOM.COMPRA_BONO
IF OBJECT_ID('RANDOM.ESPECIALIDAD_POR_PROFESIONAL') IS NOT NULL
DROP TABLE RANDOM.ESPECIALIDAD_POR_PROFESIONAL
IF OBJECT_ID('RANDOM.ESPECIALIDAD') IS NOT NULL
DROP TABLE RANDOM.ESPECIALIDAD
IF OBJECT_ID('RANDOM.TIPO_ESPECIALIDAD') IS NOT NULL
DROP TABLE RANDOM.TIPO_ESPECIALIDAD
IF OBJECT_ID('RANDOM.PROFESIONAL') IS NOT NULL
DROP TABLE RANDOM.PROFESIONAL
IF OBJECT_ID('RANDOM.HISTORIAL_PLAN') IS NOT NULL
DROP TABLE RANDOM.HISTORIAL_PLAN
IF OBJECT_ID('RANDOM.AFILIADO') IS NOT NULL
DROP TABLE RANDOM.AFILIADO
IF OBJECT_ID('RANDOM.PERSONA') IS NOT NULL
DROP TABLE RANDOM.PERSONA
IF OBJECT_ID('RANDOM.PLANES') IS NOT NULL
DROP TABLE RANDOM.PLANES
IF OBJECT_ID('RANDOM.ESTADO_CIVIL') IS NOT NULL
DROP TABLE RANDOM.ESTADO_CIVIL
IF OBJECT_ID('RANDOM.USUARIO_POR_ROL') IS NOT NULL
DROP TABLE RANDOM.USUARIO_POR_ROL
IF OBJECT_ID('RANDOM.USUARIO') IS NOT NULL
DROP TABLE RANDOM.USUARIO
IF OBJECT_ID('RANDOM.ROL_POR_FUNCIONALIDADES') IS NOT NULL
DROP TABLE RANDOM.ROL_POR_FUNCIONALIDADES
IF OBJECT_ID('RANDOM.FUNCIONALIDADES') IS NOT NULL
DROP TABLE RANDOM.FUNCIONALIDADES
IF OBJECT_ID('RANDOM.ROL') IS NOT NULL
DROP TABLE RANDOM.ROL

-- DROP PROCEDURES Y FUNCTIONS 

-- DROP TRIGGERS


-- DROP SCHEMA
IF  EXISTS (SELECT * FROM sys.schemas WHERE name = N'RANDOM')
DROP SCHEMA [RANDOM]
GO

-- CREATE SCHEMA

CREATE SCHEMA [RANDOM] AUTHORIZATION [dbo]
GO
-- CREATE TABLAS
CREATE TABLE RANDOM.ROL(
	IdRol int PRIMARY KEY IDENTITY(1,1),
	Estado bit DEFAULT 1, -- 1 activo
	Descripcion varchar(255) UNIQUE
	)

CREATE TABLE RANDOM.FUNCIONALIDADES(
	IdFuncionalidad int PRIMARY KEY IDENTITY (1,1),
	DescripcionFunc varchar(255) UNIQUE
)

CREATE TABLE RANDOM.ROL_POR_FUNCIONALIDADES(
	IdFuncionalidad int,
	IdRol int 
	)

CREATE TABLE RANDOM.USUARIO(
	IdUsuario int PRIMARY KEY IDENTITY(1,1),
	Username nvarchar(255) NOT NULL UNIQUE,
	Pass nvarchar(255) NOT NULL,
	FechaCreacion datetime,
	UltimaModificacion datetime,
	IntentosFallidos int NOT NULL DEFAULT 0,
	Estado bit NOT NULL DEFAULT 1
)
CREATE TABLE RANDOM.USUARIO_POR_ROL(
	IdUsuario int,
	IdRol int
)

CREATE TABLE RANDOM.PERSONA(
	IdPersona int PRIMARY KEY,
	Nombre nvarchar(255),
	Apellido nvarchar(255),
	TipoDocumento nvarchar(255),
	Dni numeric(18, 0),
	Direccion nvarchar(255),
	Telefono numeric(18, 0),
	Mail nvarchar(255),
	Fecha_Nac datetime,
	Sexo nvarchar(255),
	IdRol int
)

CREATE TABLE RANDOM.AFILIADO(
	IdPersona int PRIMARY KEY,
	IdEstadoCivil int,
	CantidadACargo int,
	IdPlan int,
	--IdFamiliar,
	NumeroAfiliado int,
	Estado nvarchar(255),
	NumeroUltimoBono int
)

CREATE TABLE RANDOM.PLANES(
	IdPlan int PRIMARY KEY,
	Codigo numeric(18),
	Nombre nvarchar(255),
	Abono int,
	MontoConsulta numeric(18),
	MontoExpendio numeric(18)
)

CREATE TABLE RANDOM.HISTORIAL_PLAN(
	IdHistorialPlan int PRIMARY KEY IDENTITY(1,1),
	IdAfiliado int,
	Motivo nvarchar(255),
	Fecha datetime,
	PlanElegido nvarchar(255)
)

CREATE TABLE.RANDOM.ESTADO_CIVIL(
	IdEstadoCivil int PRIMARY KEY IDENTITY (1,1),
	Descripcion nvarchar(255)
)

CREATE TABLE RANDOM.PROFESIONAL(
	IdPersona int PRIMARY KEY,
	Matricula int
)
CREATE TABLE RANDOM.TIPO_ESPECIALIDAD(
	IdTipoEspecialidad int PRIMARY KEY IDENTITY(1,1),
	Codigo numeric(18),
	Descripcion nvarchar(255)
)

CREATE TABLE RANDOM.ESPECIALIDAD(
	IdEspecialidad int PRIMARY KEY IDENTITY(1,1),
	Codigo numeric(18),
	Descripcion nvarchar(255),
	IdTipoEspecialidad int
)

CREATE TABLE RANDOM.ESPECIALIDAD_POR_PROFESIONAL(
	IdProfesional int,
	IdEspecialidad int
)

CREATE TABLE RANDOM.COMPRA_BONO(
	IdCompra int PRIMARY KEY IDENTITY (1,1),
	IdAfiliado int,
	Fecha datetime,
	MontoTotal int
)

CREATE TABLE RANDOM.BONO(
	IdBono int PRIMARY KEY IDENTITY(1,1),
	IdCompra int,
	Estado nvarchar(255),
	Precio int,
	FechaConsultaImpresion datetime,
	ConsultaNumero numeric(18)
)

CREATE TABLE RANDOM.DIA(
	IdDia int PRIMARY KEY IDENTITY (1,1),
	Dia nvarchar(255)
)

CREATE TABLE RANDOM.AGENDA_HORARIO_DISPONIBLE(
	IdAgenda int PRIMARY KEY IDENTITY (1,1),
	IdProfesional int,
	IdDia int,
	Hora datetime,
	IdEspecialidad int,
	EstadoDisponibilidad nvarchar(255)
)
--TURNO NUMERO, TURNO FECHA AGENDA O TURNO? EN LA MAESTRA ESTA

CREATE TABLE RANDOM.TURNO(
	IdTurno int PRIMARY KEY IDENTITY(1,1),
	IdAgenda int,
	Estado nvarchar(255),
	IdBono int,
	IdResultado int
)

CREATE TABLE RANDOM.RESULTADO_TURNO(
	IdResultadoTurno int PRIMARY KEY IDENTITY(1,1),
	Sintomas nvarchar(255),
	Enfermedades nvarchar(255),
	Fecha datetime
)

CREATE TABLE RANDOM.CANCELACION(
	IdCancelacion int PRIMARY KEY IDENTITY(1,1),
	IdTipoCancelacion int,
	IdTurno int
)

CREATE TABLE RANDOM.TIPO_CANCELACION(
	IdTipoCancelacion int PRIMARY KEY IDENTITY(1,1),
	Descripcion nvarchar(255)
)
--FOREIGN KEY 

ALTER TABLE RANDOM.ROL_POR_FUNCIONALIDADES ADD FOREIGN KEY (IdFuncionalidad) REFERENCES RANDOM.FUNCIONALIDADES
ALTER TABLE RANDOM.ROL_POR_FUNCIONALIDADES ADD FOREIGN KEY (IdRol) REFERENCES RANDOM.ROL
ALTER TABLE RANDOM.USUARIO_POR_ROL ADD FOREIGN KEY (IdUsuario) REFERENCES RANDOM.USUARIO
ALTER TABLE RANDOM.USUARIO_POR_ROL ADD FOREIGN KEY (IdRol) REFERENCES RANDOM.ROL
ALTER TABLE RANDOM.AFILIADO ADD FOREIGN KEY (IdPersona) REFERENCES RANDOM.PERSONA
ALTER TABLE RANDOM.AFILIADO ADD FOREIGN KEY (IdEstadoCivil) REFERENCES RANDOM.ESTADO_CIVIL
ALTER TABLE RANDOM.AFILIADO ADD FOREIGN KEY (IdPlan) REFERENCES RANDOM.PLANES
ALTER TABLE RANDOM.HISTORIAL_PLAN ADD FOREIGN KEY (IdAfiliado) REFERENCES RANDOM.AFILIADO
ALTER TABLE RANDOM.PROFESIONAL ADD FOREIGN KEY (IdPersona) REFERENCES RANDOM.PERSONA
ALTER TABLE RANDOM.ESPECIALIDAD ADD FOREIGN KEY (IdTipoEspecialidad) REFERENCES RANDOM.TIPO_ESPECIALIDAD
ALTER TABLE RANDOM.ESPECIALIDAD_POR_PROFESIONAL ADD FOREIGN KEY (IdProfesional) REFERENCES RANDOM.PROFESIONAL
ALTER TABLE RANDOM.ESPECIALIDAD_POR_PROFESIONAL ADD FOREIGN KEY (IdEspecialidad) REFERENCES RANDOM.ESPECIALIDAD
ALTER TABLE RANDOM.COMPRA_BONO ADD FOREIGN KEY (IdAfiliado) REFERENCES RANDOM.AFILIADO
ALTER TABLE RANDOM.BONO ADD FOREIGN KEY (IdCompra) REFERENCES RANDOM.COMPRA_BONO
ALTER TABLE RANDOM.AGENDA_HORARIO_DISPONIBLE ADD FOREIGN KEY (IdProfesional) REFERENCES RANDOM.PROFESIONAL
ALTER TABLE RANDOM.AGENDA_HORARIO_DISPONIBLE ADD FOREIGN KEY (IdDia) REFERENCES RANDOM.DIA
ALTER TABLE RANDOM.AGENDA_HORARIO_DISPONIBLE ADD FOREIGN KEY (IdEspecialidad) REFERENCES RANDOM.ESPECIALIDAD
ALTER TABLE RANDOM.TURNO ADD FOREIGN KEY (IdAgenda) REFERENCES RANDOM.AGENDA_HORARIO_DISPONIBLE
ALTER TABLE RANDOM.TURNO ADD FOREIGN KEY (IdBono) REFERENCES RANDOM.BONO
ALTER TABLE RANDOM.TURNO ADD FOREIGN KEY (IdResultado) REFERENCES RANDOM.RESULTADO_TURNO
ALTER TABLE RANDOM.CANCELACION ADD FOREIGN KEY (IdTipoCancelacion) REFERENCES RANDOM.TIPO_CANCELACION
ALTER TABLE RANDOM.CANCELACION ADD FOREIGN KEY (IdTurno) REFERENCES RANDOM.TURNO

------------------------  MIGRACION  ------------------------------

INSERT INTO RANDOM.ROL(Descripcion)
VALUES ('Administrador')
INSERT INTO RANDOM.ROL(Descripcion)
VALUES ('Afiliado')
INSERT INTO RANDOM.ROL(Descripcion)
VALUES ('Profesional')

SET IDENTITY_INSERT RANDOM.FUNCIONALIDADES ON
INSERT INTO RANDOM.FUNCIONALIDADES(IdFuncionalidad,DescripcionFunc)
VALUES (0,'Alta Afiliado')
INSERT INTO RANDOM.FUNCIONALIDADES(IdFuncionalidad,DescripcionFunc)
VALUES (1,'Modificar Afiliado')
INSERT INTO RANDOM.FUNCIONALIDADES(IdFuncionalidad,DescripcionFunc)
VALUES (2,'Baja Afiliado')
INSERT INTO RANDOM.FUNCIONALIDADES(IdFuncionalidad,DescripcionFunc)
VALUES (3,'Alta Profesional')
INSERT INTO RANDOM.FUNCIONALIDADES(IdFuncionalidad,DescripcionFunc)
VALUES (4,'Modificar Profesional')
INSERT INTO RANDOM.FUNCIONALIDADES(IdFuncionalidad,DescripcionFunc)
VALUES (5,'Baja Profesional')
INSERT INTO RANDOM.FUNCIONALIDADES(IdFuncionalidad,DescripcionFunc)
VALUES (6,'Generar Agenda')
INSERT INTO RANDOM.FUNCIONALIDADES(IdFuncionalidad,DescripcionFunc)
VALUES (7,'Comprar Bono')
INSERT INTO RANDOM.FUNCIONALIDADES(IdFuncionalidad,DescripcionFunc)
VALUES (8,'Registrar Llegada a la Atención')
INSERT INTO RANDOM.FUNCIONALIDADES(IdFuncionalidad,DescripcionFunc)
VALUES (9,'Solicitar Turno')
INSERT INTO RANDOM.FUNCIONALIDADES(IdFuncionalidad,DescripcionFunc)
VALUES (10,'Cancelar Turno')
INSERT INTO RANDOM.FUNCIONALIDADES(IdFuncionalidad,DescripcionFunc)
VALUES (11,'Registrar Diagnóstico')
INSERT INTO RANDOM.FUNCIONALIDADES(IdFuncionalidad,DescripcionFunc)
VALUES (12,'Consulta TOP 5')
SET IDENTITY_INSERT RANDOM.FUNCIONALIDADES OFF

INSERT INTO RANDOM.ROL_POR_FUNCIONALIDADES
VALUES(0,1)
INSERT INTO RANDOM.ROL_POR_FUNCIONALIDADES
VALUES(1,1)
INSERT INTO RANDOM.ROL_POR_FUNCIONALIDADES
VALUES(2,1)
INSERT INTO RANDOM.ROL_POR_FUNCIONALIDADES
VALUES(3,1)
INSERT INTO RANDOM.ROL_POR_FUNCIONALIDADES
VALUES(4,1)
INSERT INTO RANDOM.ROL_POR_FUNCIONALIDADES
VALUES(5,1)
INSERT INTO RANDOM.ROL_POR_FUNCIONALIDADES
VALUES(6,3)
INSERT INTO RANDOM.ROL_POR_FUNCIONALIDADES
VALUES(7,1)
INSERT INTO RANDOM.ROL_POR_FUNCIONALIDADES
VALUES(7,2)
INSERT INTO RANDOM.ROL_POR_FUNCIONALIDADES
VALUES(8,1)
INSERT INTO RANDOM.ROL_POR_FUNCIONALIDADES
VALUES(9,2)
INSERT INTO RANDOM.ROL_POR_FUNCIONALIDADES
VALUES(10,2)
INSERT INTO RANDOM.ROL_POR_FUNCIONALIDADES
VALUES(10,3)
INSERT INTO RANDOM.ROL_POR_FUNCIONALIDADES
VALUES(11,3)
INSERT INTO RANDOM.ROL_POR_FUNCIONALIDADES
VALUES(12,2)

INSERT INTO RANDOM.USUARIO(Username,Pass)
VALUES('admin','e6b87050bfcb8143fcb8db0170a4dc9ed00d904ddd3e2a4ad1b1e8dc0fdc9be7')
INSERT INTO RANDOM.USUARIO(Username,Pass)
VALUES('ana','e6b87050bfcb8143fcb8db0170a4dc9ed00d904ddd3e2a4ad1b1e8dc0fdc9be7')
INSERT INTO RANDOM.USUARIO(Username,Pass)
VALUES('maria','e6b87050bfcb8143fcb8db0170a4dc9ed00d904ddd3e2a4ad1b1e8dc0fdc9be7')
INSERT INTO RANDOM.USUARIO(Username,Pass)
VALUES('jose','e6b87050bfcb8143fcb8db0170a4dc9ed00d904ddd3e2a4ad1b1e8dc0fdc9be7')
INSERT INTO RANDOM.USUARIO(Username,Pass)
VALUES('pepe','e6b87050bfcb8143fcb8db0170a4dc9ed00d904ddd3e2a4ad1b1e8dc0fdc9be7')

INSERT INTO RANDOM.USUARIO_POR_ROL(IdUsuario,IdRol)
SELECT U.IdUsuario, 1
FROM RANDOM.USUARIO U, RANDOM.ROL R
WHERE R.Descripcion = 'Administrador'